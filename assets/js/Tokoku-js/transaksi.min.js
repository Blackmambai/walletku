document.addEventListener("DOMContentLoaded",(()=>{const t=document.getElementById("cariProduk"),n=document.getElementById("daftarProduk"),a=document.getElementById("keranjang"),e=document.getElementById("totalHarga"),o=document.getElementById("btnProsesPembayaran"),s=document.getElementById("formTambahProdukCepat"),l=document.getElementById("formPembayaran"),d=document.getElementById("strukPembayaran"),r=document.getElementById("btnCetakNota");let i=[],c=JSON.parse(localStorage.getItem("produk")||"[]");function m(t){const n=JSON.parse(localStorage.getItem("pengaturanToko")||"{}"),a=new Date(t.tanggal).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit",timeZone:"Asia/Jakarta"})+" WIB";return`  \n            <div id="strukCetak" class="container-fluid p-3" style="  \n                max-width: 400px;   \n                margin: 0 auto;   \n                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;  \n                border: 2px solid #4a90e2;  \n                border-radius: 10px;  \n                box-shadow: 0 0 15px rgba(74, 144, 226, 0.3);  \n                position: relative;  \n                overflow: hidden;  \n                background: linear-gradient(135deg, #f8f9fa 0%, #e9f5ff 100%);  \n            ">  \n                \x3c!-- Watermark --\x3e  \n                <div style="  \n                    position: absolute;  \n                    opacity: 0.1;  \n                    font-size: 120px;  \n                    font-weight: bold;  \n                    color: #4a90e2;  \n                    transform: rotate(-30deg);  \n                    top: 30%;  \n                    left: 10%;  \n                    z-index: 0;  \n                    pointer-events: none;  \n                ">  \n                    walletku.biz.id  \n                </div>  \n                \n                <div class="position-relative" style="z-index: 1;">  \n                    \x3c!-- Header --\x3e  \n                    <div class="text-center mb-3">  \n                        ${n.logoToko?`<img src="${n.logoToko}"   \n                                   class="img-fluid mb-2"   \n                                   style="max-height: 80px;">`:""}  \n                        <h3 class="mb-1" style="color: #2c3e50; font-weight: bold;">  \n                            ${n.namaToko||"TOKO SAYA"}  \n                        </h3>  \n                        <p class="mb-1 text-muted small">  \n                            <i class="fas fa-map-marker-alt"></i> ${n.alamatToko||"Alamat Tidak Tersedia"}  \n                        </p>  \n                        <p class="mb-2 text-muted small">  \n                            <i class="fab fa-whatsapp"></i> ${n.nomorWAToko||"-"}  \n                        </p>  \n                        <hr style="border-top: 2px dashed #4a90e2; opacity: 0.7;">  \n                    </div>  \n                    \n                    \x3c!-- Customer Info --\x3e  \n                    <div class="mb-3">  \n                        <div class="d-flex justify-content-between mb-1">  \n                            <span class="text-muted">Nama:</span>  \n                            <span style="font-weight: 500;">${t.namaPelanggan||"Pelanggan Umum"}</span>  \n                        </div>  \n                        <div class="d-flex justify-content-between mb-1">  \n                            <span class="text-muted">Tanggal:</span>  \n                            <span style="font-weight: 500;">${a}</span>  \n                        </div>  \n                        <div class="d-flex justify-content-between mb-2">  \n                            <span class="text-muted">Metode:</span>  \n                            <span class="badge bg-primary">${t.metodePembayaran}</span>  \n                        </div>  \n                        <hr style="border-top: 2px dashed #4a90e2; opacity: 0.7;">  \n                    </div>  \n                    \n                    \x3c!-- Product List --\x3e  \n                    <div class="mb-3">  \n                        <table class="table table-sm">  \n                            <thead>  \n                                <tr style="background-color: #e9f5ff;">  \n                                    <th class="ps-0" style="color: #2c3e50;">Produk</th>  \n                                    <th class="text-end pe-0" style="color: #2c3e50;">Jumlah</th>  \n                                    <th class="text-end pe-0" style="color: #2c3e50;">Total</th>  \n                                </tr>  \n                            </thead>  \n                            <tbody>  \n                                ${t.produk.map((t=>`  \n                                    <tr>  \n                                        <td class="ps-0">${t.nama}</td>  \n                                        <td class="text-end pe-0">${t.jumlah} x ${t.harga.toLocaleString()}</td>  \n                                        <td class="text-end pe-0" style="font-weight: 500;">${(t.harga*t.jumlah).toLocaleString()}</td>  \n                                    </tr>  \n                                `)).join("")}  \n                            </tbody>  \n                        </table>  \n                        \n                        <hr style="border-top: 2px dashed #4a90e2; opacity: 0.7;">  \n                        \n                        \x3c!-- Summary --\x3e  \n                        <div class="mb-2">  \n                            <div class="d-flex justify-content-between">  \n                                <span class="text-muted">Total:</span>  \n                                <span class="fw-bold" style="color: #2c3e50;">Rp ${t.totalHarga.toLocaleString()}</span>  \n                            </div>  \n                            <div class="d-flex justify-content-between">  \n                                <span class="text-muted">Bayar:</span>  \n                                <span class="fw-bold" style="color: #27ae60;">Rp ${t.uangDiterima.toLocaleString()}</span>  \n                            </div>  \n                            <div class="d-flex justify-content-between">  \n                                <span class="text-muted">Kembali:</span>  \n                                <span class="fw-bold" style="color: #e74c3c;">Rp ${t.kembalian.toLocaleString()}</span>  \n                            </div>  \n                        </div>  \n                        \n                        <hr style="border-top: 2px dashed #4a90e2; opacity: 0.7;">  \n                        \n                        \x3c!-- Footer --\x3e  \n                        <div class="text-center mt-3">  \n                            <p class="small text-muted mb-1">  \n                                ${n.catatanKakiStruk||"Terima Kasih Telah Berbelanja"}  \n                            </p>\n                            <div class="align-item-center">\n                            <p class="" style="font-size: 14px; color: #4a90e2; font-weight: 500; margin: 0;">  \n                                <i class="fas fa-wallet"></i> WalletKu.biz.id  \n                            </p>\n                            <p class="" style="font-size: 14px; color: #4a90e2; font-weight: 500; margin: 0;">  \n                                <i class=""></i>Ahli mengatur toko dan keuangan  \n                            </p>\n                            </div>\n                        </div>  \n                    </div>  \n                </div>  \n            </div>  \n        `}function u(t=""){const a=c.filter((n=>n.stokProduk>0&&n.namaProduk.toLowerCase().includes(t.toLowerCase())));n.innerHTML=a.map((t=>`  \n            <div class="col-md-4" style="padding: 5px;margin-bottom: 16px;">  \n                <div class="card summary-card paddingAll produk01" style="padding: 10px;">  \n                    <div class="card-body" style="padding: 0px;">  \n                        <img src="${t.fotoProduk||"https://walletku.biz.id/assets/img/image/notfound.webp"}" class="card-img-top" alt="${t.namaProduk}" style="border-radius: 16px 16px 0 0; object-fit: cover; height: 200px; margin-bottom: 16px;">  \n                        <h5 class="card-title" style="font-family: Nunito, sans-serif;font-size: 20px;font-weight: bold;">${t.namaProduk}</h5>  \n                        <p class="card-text" style="font-family: Nunito, sans-serif;font-size: 16px;color: rgb(43,43,44);font-weight: bold;">  \n                            Harga: Rp ${t.hargaJual.toLocaleString()}<br />  \n                            Stok: ${t.stokProduk}  \n                        </p>  \n                        <button class="btn btn-primary text-nowrap text-start d-flex d-xxl-flex justify-content-center align-items-center tambah-produk btnproduk1"  \n                                data-nama="${t.namaProduk}"  \n                                data-harga="${t.hargaJual}"  \n                                data-stok="${t.stokProduk}">  \n                            <i class="fas fa-plus-circle" style="margin-right: 10px;"></i> Tambah  \n                        </button>  \n                    </div>  \n                </div>  \n            </div>  \n        `)).join(""),document.querySelectorAll(".tambah-produk").forEach((t=>{t.addEventListener("click",g)}))}function g(t){const n=t.currentTarget.dataset.nama,a=parseFloat(t.currentTarget.dataset.harga),e=(parseInt(t.currentTarget.dataset.stok),c.find((t=>t.namaProduk===n)));if(!e)return;const o=i.find((t=>t.nama===n)),s=o?o.jumlah:0;e.stokProduk<=s?alert("Stok produk tidak mencukupi!"):(o?o.jumlah++:i.push({nama:n,harga:a,jumlah:1}),p())}function p(){a.innerHTML=i.map(((t,n)=>{const a=c.find((n=>n.namaProduk===t.nama)),e=a?a.stokProduk:0,o=t.jumlah>e?'style="color: red;"':"";return`  \n                <li class="list-group-item d-flex justify-content-between align-items-center">  \n                    <div>  \n                        <strong>${t.nama}</strong>  \n                        <small class="d-block">Rp ${t.harga.toLocaleString()} x ${t.jumlah}</small>  \n                        <small class="d-block" ${o}>Stok tersedia: ${e}</small>  \n                    </div>  \n                    <div>  \n                        <button class="btn btn-sm btn-outline-danger me-2 kurang-item" data-index="${n}" data-nama="${t.nama}">  \n                            <i class="fas fa-minus"></i>  \n                        </button>  \n                        <button class="btn btn-sm btn-outline-danger hapus-item" data-index="${n}" data-nama="${t.nama}">  \n                            <i class="fas fa-trash"></i>  \n                        </button>  \n                    </div>  \n                </li>  \n            `})).join("");const t=i.reduce(((t,n)=>t+n.harga*n.jumlah),0);e.textContent=`Rp ${t.toLocaleString()}`,document.querySelectorAll(".kurang-item").forEach((t=>{t.addEventListener("click",f)})),document.querySelectorAll(".hapus-item").forEach((t=>{t.addEventListener("click",k)}))}function f(t){const n=t.currentTarget.dataset.index;i[n].jumlah>1?i[n].jumlah--:i.splice(n,1),p()}function k(t){const n=t.currentTarget.dataset.index;i.splice(n,1),p()}s.addEventListener("submit",(t=>{t.preventDefault();const n={namaProduk:document.getElementById("namaProdukBaru").value,hargaJual:parseFloat(document.getElementById("hargaProdukBaru").value),stokProduk:parseInt(document.getElementById("stokProdukBaru").value),fotoProduk:"https://walletku.biz.id/assets/img/notfound.webp"};c.push(n),localStorage.setItem("produk",JSON.stringify(c)),s.reset(),bootstrap.Modal.getInstance(document.getElementById("modalTambahProduk")).hide(),u()})),o.addEventListener("click",(()=>{if(0===i.length)return void alert("Keranjang masih kosong");let t=!0;if(i.forEach((n=>{const a=c.find((t=>t.namaProduk===n.nama));(!a||a.stokProduk<n.jumlah)&&(t=!1,alert(`Stok tidak cukup untuk produk ${n.nama}`))})),!t)return;const n=i.reduce(((t,n)=>t+n.harga*n.jumlah),0);document.getElementById("totalPembayaran").value=`Rp ${n.toLocaleString()}`,new bootstrap.Modal(document.getElementById("modalPembayaran")).show()})),l.addEventListener("submit",(n=>{n.preventDefault();const a=i.reduce(((t,n)=>t+n.harga*n.jumlah),0),e=parseFloat(document.getElementById("uangDiterima").value),o=document.getElementById("namaPelanggan").value,s=document.getElementById("metodePembayaran").value;if(e<a)return void alert("Uang yang diterima kurang");i.forEach((n=>{!function(n,a,e="kurangi"){const o=c.findIndex((t=>t.namaProduk===n));-1!==o&&("kurangi"===e?c[o].stokProduk-=a:c[o].stokProduk+=a,c[o].stokProduk=Math.max(c[o].stokProduk,0),localStorage.setItem("produk",JSON.stringify(c)),u(t.value))}(n.nama,n.jumlah,"kurangi")}));const g=JSON.parse(localStorage.getItem("nota")||"[]"),f={tanggal:(new Date).toISOString(),namaPelanggan:o,metodePembayaran:s,produk:i,totalHarga:a,uangDiterima:e,kembalian:e-a};g.push(f),localStorage.setItem("nota",JSON.stringify(g)),d.innerHTML=m(f);new bootstrap.Modal(document.getElementById("modalStruk")).show(),r.onclick=()=>{!function(t){const n=window.open("","_blank","width=800,height=600");t?(n.document.open(),n.document.write(`  \n            <html>  \n                <head>  \n                    <title>Cetak Nota</title>  \n                    <style>  \n                        @media print {  \n                            body { display: flex; justify-content: center; align-items: center; margin: 0; padding: 0; }  \n                            #strukCetak { max-width: 300px !important; margin: 0 auto !important; }  \n                        }  \n                        body { font-family: 'Courier New', monospace; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }  \n                    </style>  \n                </head>  \n                <body>  \n                    ${m(t)}  \n                    <script>  \n                        window.onload = function() {  \n                            window.print();  \n                            window.close();  \n                        }  \n                    <\/script>  \n                </body>  \n            </html>  \n        `),n.document.close()):alert("Nota tidak valid")}(f)},i=[],p(),l.reset(),bootstrap.Modal.getInstance(document.getElementById("modalPembayaran")).hide()})),document.getElementById("uangDiterima").addEventListener("input",(t=>{const n=i.reduce(((t,n)=>t+n.harga*n.jumlah),0),a=parseFloat(t.target.value)-n;document.getElementById("kembalian").value=`Rp ${a.toLocaleString()}`})),u(),t.addEventListener("input",(t=>{u(t.target.value)}))}));
document.addEventListener("DOMContentLoaded",(()=>{const n=document.getElementById("daftarNota"),t=document.getElementById("btnExportNota"),e=document.getElementById("btnTerapkanFilter"),a=new bootstrap.Modal(document.getElementById("modalDetailNota")),o=document.getElementById("detailNotaContent"),i=document.getElementById("btnCetakNota"),l=document.getElementById("btnUnduhPNG");let d=[],r=null;function s(t={}){if(d=JSON.parse(localStorage.getItem("nota")||"[]"),t.tanggalMulai||t.tanggalSelesai){const n=t.tanggalMulai?new Date(t.tanggalMulai):null,e=t.tanggalSelesai?new Date(t.tanggalSelesai):null;e&&e.setHours(23,59,59,999),d=d.filter((t=>{const a=new Date(t.tanggal);return(!n||a>=n)&&(!e||a<=e)}))}t.tanggalMulai&&(startDate=new Date(t.tanggalMulai+"T00:00:00")),t.tanggalSelesai&&(endDate=new Date(t.tanggalSelesai+"T23:59:59")),t.metodePembayaran&&(d=d.filter((n=>n.metodePembayaran===t.metodePembayaran))),d.sort(((n,t)=>new Date(t.tanggal)-new Date(n.tanggal))),n.innerHTML=d.map(((n,t)=>`\n            <tr>\n                <td>${n.tanggal}</td>\n                <td>${n.namaPelanggan}</td>\n                <td>Rp ${n.totalHarga.toLocaleString()}</td>\n                <td>${n.metodePembayaran}</td>\n                <td>\n                    <button class="btn btn-sm btn-danger detail-nota" style="border-radius: 16px;font-family: Nunito, sans-serif;box-shadow: 0px 6px 14px rgba(67,97,238,0.56);width: auto;" data-index="${t}">\n                        <i class="fas fa-eye"></i> Detail\n                    </button>\n                    <button class="btn btn-sm btn-danger hapus-nota" style="border-radius: 16px;font-family: Nunito, sans-serif;box-shadow: 0px 6px 14px rgba(67,97,238,0.56);width: auto;" data-index="${t}">\n                        <i class="fas fa-trash"></i> Hapus\n                    </button>\n                </td>\n            </tr>\n        `)).join(""),document.querySelectorAll(".detail-nota").forEach((n=>{n.addEventListener("click",g)})),document.querySelectorAll(".hapus-nota").forEach((n=>{n.addEventListener("click",c)}))}function g(n){const t=n.currentTarget.dataset.index;r=d[t];const e=new Date(r.tanggal).toLocaleDateString("id-ID",{weekday:"long",day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})+" WIB";o.innerHTML=`\n            <div id="strukCetak" style="\n                max-width: 100%;\n                margin: 0 auto;\n                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n                padding: 20px;\n                border: 2px solid #4a90e2;\n                border-radius: 10px;\n                box-shadow: 0 0 15px rgba(74, 144, 226, 0.2);\n                background: linear-gradient(135deg, #f8f9fa 0%, #e9f5ff 100%);\n                position: relative;\n                overflow: hidden;\n            ">\n                \x3c!-- Watermark --\x3e\n                <div style="\n                    position: absolute;\n                    opacity: 0.08;\n                    font-size: 120px;\n                    font-weight: bold;\n                    color: #4a90e2;\n                    transform: rotate(-30deg);\n                    top: 30%;\n                    left: 10%;\n                    z-index: 0;\n                    pointer-events: none;\n                ">\n                    NOTABOOST\n                </div>\n\n                \x3c!-- Header --\x3e\n                <div class="text-center mb-4">\n                    <h3 style="color: #2c3e50; font-weight: bold; margin-bottom: 5px;">NOTA PENJUALAN</h3>\n                    <hr style="border-top: 2px dashed #4a90e2; opacity: 0.7;">\n                </div>\n\n                \x3c!-- Informasi Nota --\x3e\n                <div class="row" style="margin-bottom: 20px;">\n                    <div class="col-md-6">\n                        <div style="background-color: #e9f5ff; padding: 12px; border-radius: 8px;">\n                            <h5 style="color: #2c3e50; border-bottom: 1px solid #4a90e2; padding-bottom: 5px; font-size: 1rem;">\n                                <i class="fas fa-info-circle"></i> INFORMASI NOTA\n                            </h5>\n                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">\n                                <span style="color: #6c757d;">Tanggal:</span>\n                                <span style="font-weight: 500;">${e}</span>\n                            </div>\n                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">\n                                <span style="color: #6c757d;">Nama Pelanggan:</span>\n                                <span style="font-weight: 500;">${r.namaPelanggan}</span>\n                            </div>\n                            <div style="display: flex; justify-content: space-between;" class="align-items-start">\n                                <span style="color: #6c757d;">Metode Pembayaran:</span>\n                                <span class="badge text-nowrap" style="background-color: #4a90e2; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem;">\n                                    ${r.metodePembayaran}\n                                </span>\n                            </div>\n                        </div>\n                    </div>\n                    \n                    <div class="col-md-6">\n                        <div style="background-color: #f0f8ff; padding: 12px; border-radius: 8px;">\n                            <h5 style="color: #2c3e50; border-bottom: 1px solid #4a90e2; padding-bottom: 5px; font-size: 1rem;">\n                                <i class="fas fa-receipt"></i> RINGKASAN TRANSAKSI\n                            </h5>\n                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">\n                                <span style="color: #6c757d;">Total Penjualan:</span>\n                                <span style="font-weight: bold; color: #2c3e50;">Rp ${r.totalHarga.toLocaleString()}</span>\n                            </div>\n                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">\n                                <span style="color: #6c757d;">Uang Diterima:</span>\n                                <span style="font-weight: bold; color: #28a745;">Rp ${r.uangDiterima.toLocaleString()}</span>\n                            </div>\n                            <div style="display: flex; justify-content: space-between;">\n                                <span style="color: #6c757d;">Kembalian:</span>\n                                <span style="font-weight: bold; color: #dc3545;">Rp ${r.kembalian.toLocaleString()}</span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Daftar Produk --\x3e\n                <div>\n                    <h5 style="color: #2c3e50; border-bottom: 1px solid #4a90e2; padding-bottom: 5px; font-size: 1rem;">\n                        <i class="fas fa-boxes"></i> DAFTAR PRODUK\n                    </h5>\n                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">\n                        <thead>\n                            <tr style="background-color: #e9f5ff; border-bottom: 2px solid #4a90e2;">\n                                <th style="padding: 8px; text-align: left;">Produk</th>\n                                <th style="padding: 8px; text-align: right;">Harga</th>\n                                <th style="padding: 8px; text-align: center;">Jumlah</th>\n                                <th style="padding: 8px; text-align: right;">Total</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            ${r.produk.map((n=>`\n                                <tr style="border-bottom: 1px solid #e0e0e0;">\n                                    <td style="padding: 8px;">${n.nama}</td>\n                                    <td style="padding: 8px; text-align: right;">Rp ${n.harga.toLocaleString()}</td>\n                                    <td style="padding: 8px; text-align: center;">${n.jumlah}</td>\n                                    <td style="padding: 8px; text-align: right; font-weight: 500;">Rp ${(n.harga*n.jumlah).toLocaleString()}</td>\n                                </tr>\n                            `)).join("")}\n                        </tbody>\n                    </table>\n                </div>\n\n                \x3c!-- Footer --\x3e\n                <div style="text-align: center; margin-top: 20px;">\n                    <p style="font-size: 0.8rem; color: #6c757d; margin-bottom: 5px;">\n                        Terima kasih telah berbelanja dengan kami\n                    </p>\n                    <p class="premium2" style="font-size: 0.7rem; color: #4a90e2; font-weight: 500; margin: 0;">\n                        <i class="fas fa-lock premium"></i> WalletKu.biz.id | Upgrade Premium\n                    </p>\n                </div>\n            </div>\n        `,a.show()}function c(n){const t=n.currentTarget.dataset.index;confirm("Apakah Anda yakin ingin menghapus nota ini?")&&(d.splice(t,1),localStorage.setItem("nota",JSON.stringify(d)),s())}t.addEventListener("click",(()=>{(new Date).toISOString(),namaPelanggan,metodePembayaran,keranjangItems,total,uangDiterima,uangDiterima,total;const n=new Blob([csvContent],{type:"text/csv;charset=utf-8;"}),t=document.createElement("a"),e=URL.createObjectURL(n);t.setAttribute("href",e),t.setAttribute("download",`nota_${(new Date).toISOString().split("T")[0]}.csv`),t.style.visibility="hidden",document.body.appendChild(t),t.click(),document.body.removeChild(t)})),e.addEventListener("click",(()=>{s({tanggalMulai:document.getElementById("tanggalMulai").value,tanggalSelesai:document.getElementById("tanggalSelesai").value,metodePembayaran:document.getElementById("metodePembayaran").value}),bootstrap.Modal.getInstance(document.getElementById("modalFilterNota")).hide()})),i.addEventListener("click",(()=>{if(r){const n=document.createElement("div");n.innerHTML=o.innerHTML;const t=document.body.innerHTML;document.body.innerHTML=n.innerHTML,window.print(),document.body.innerHTML=t}})),l.addEventListener("click",(async function(){if(r)try{const n=await html2canvas(document.getElementById("strukCetak"),{scale:2,logging:!1,useCORS:!0,allowTaint:!0,backgroundColor:null}),t=document.createElement("a");t.download=`nota_${r.tanggal}_${r.namaPelanggan}.png`,t.href=n.toDataURL("image/png"),t.click()}catch(n){console.error("Error generating PNG:",n),alert("Gagal mengunduh nota sebagai PNG. Pastikan Anda memiliki koneksi internet untuk menggunakan fitur ini.")}})),s()}));
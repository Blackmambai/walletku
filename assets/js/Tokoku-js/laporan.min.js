document.addEventListener("DOMContentLoaded",(()=>{const n=document.getElementById("totalPenjualan"),t=document.getElementById("totalLaba"),a=document.getElementById("produkTerjual"),e=document.getElementById("detailPenjualan"),i=document.getElementById("produkTerlaris"),o=document.getElementById("btnHarian"),l=document.getElementById("btnBulanan"),r=document.getElementById("btnExportLaporan"),s=(document.getElementById("btnTerapkanFilter"),document.getElementById("filterProduk")),d=document.getElementById("tanggalMulai"),c=document.getElementById("tanggalSelesai"),g=document.getElementById("btnMingguan"),m=document.getElementById("btnCustom"),u=document.getElementById("btnHariIni"),p=document.getElementById("btnMingguIni"),b=document.getElementById("btnBulanIni"),y=document.getElementById("btnTahunIni"),h=document.getElementById("kunjunganHariIni");let f=[],k=[],v=null,x=null;function w(n){const t=window.open("","_blank","width=600,height=600");n?(t.document.open(),t.document.write(`  \n            <html>  \n                <head>  \n                    <title>Cetak Nota</title>  \n                    <style>  \n                        @media print {  \n                            body {   \n                                display: flex;   \n                                justify-content: center;   \n                                align-items: center;   \n                                margin: 0;  \n                                padding: 0;  \n                            }  \n                            #strukCetak {   \n                                max-width: 600px !important;   \n                                margin: 0 auto !important;  \n                            }  \n                        }  \n                        body {   \n                            font-family: 'Courier New', monospace;   \n                            display: flex;   \n                            justify-content: center;   \n                            align-items: center;   \n                            height: 100vh;   \n                            margin: 0;   \n                        }  \n                    </style>  \n                </head>  \n                <body>  \n                    ${function(n){const t=JSON.parse(localStorage.getItem("pengaturanToko")||"{}"),a=new Date(n.tanggal).toLocaleDateString("id-ID",{day:"2-digit",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})+" WIB";return`  \n            <div id="strukCetak" style="  \n                max-width: 300px;  \n                width: 100%;  \n                margin: 0 auto;  \n                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;  \n                padding: 12px;  \n                border: 2px solid #4a90e2;  \n                border-radius: 8px;  \n                box-shadow: 0 0 10px rgba(74, 144, 226, 0.2);  \n                background: linear-gradient(135deg, #f8f9fa 0%, #e9f5ff 100%);  \n                position: relative;  \n                overflow: hidden;">  \n                \x3c!-- Watermark --\x3e  \n                <div style="  \n                    position: absolute;  \n                    opacity: 0.1;  \n                    font-size: 80px;  \n                    font-weight: bold;  \n                    color: #4a90e2;  \n                    transform: rotate(-30deg);  \n                    top: 30%;  \n                    left: 10%;  \n                    z-index: 0;  \n                    pointer-events: none;">  \n                    ${t.namaToko||"TOKO SAYA"}  \n                </div>  \n\n                \x3c!-- Konten Struk --\x3e  \n                <div style="position: relative; z-index: 1;">  \n                    \x3c!-- Header --\x3e  \n                    <div style="text-align: center; margin-bottom: 10px;">  \n                        ${t.logoToko?`<img src="${t.logoToko}"   \n                               style="max-height: 70px; margin-bottom: 5px;">`:""}  \n                        <h3 style="margin: 0; color: #2c3e50; font-size: 1.2rem; font-weight: bold;">  \n                            ${t.namaToko||"TOKO SAYA"}  \n                        </h3>  \n                        <p style="margin: 3px 0; font-size: 0.7rem; color: #6c757d;">  \n                            <i class="fas fa-map-marker-alt"></i> ${t.alamatToko||"Alamat Tidak Tersedia"}  \n                        </p>  \n                        <p style="margin: 3px 0; font-size: 0.7rem; color: #6c757d;">  \n                            <i class="fab fa-whatsapp"></i> ${t.nomorWAToko||"-"}  \n                        </p>  \n                        <hr style="border-top: 1px dashed #4a90e2; margin: 8px 0; opacity: 0.7;">  \n                    </div>  \n\n                    \x3c!-- Info Pelanggan --\x3e  \n                    <div style="margin-bottom: 10px; font-size: 0.8rem;">  \n                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">  \n                            <span style="color: #6c757d;">Nama:</span>  \n                            <span style="font-weight: 500;">${n.namaPelanggan||"Pelanggan Umum"}</span>  \n                        </div>  \n                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">  \n                            <span style="color: #6c757d;">Tanggal:</span>  \n                            <span style="font-weight: 500;">${a}</span>  \n                        </div>  \n                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">  \n                            <span style="color: #6c757d;">Metode:</span>  \n                            <span style="background-color: #4a90e2; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem;">  \n                                ${n.metodePembayaran}  \n                            </span>  \n                        </div>  \n                        <hr style="border-top: 1px dashed #4a90e2; margin: 8px 0; opacity: 0.7;">  \n                    </div>  \n\n                    \x3c!-- Daftar Produk --\x3e  \n                    <table style="width: 100%; font-size: 0.8rem; margin-bottom: 10px;">  \n                        <thead>  \n                            <tr style="border-bottom: 1px solid #e9f5ff;">  \n                                <th style="text-align: left; padding-bottom: 5px;">Produk</th>  \n                                <th style="text-align: right; padding-bottom: 5px;">Jumlah</th>  \n                                <th style="text-align: right; padding-bottom: 5px;">Total</th>  \n                            </tr>  \n                        </thead>  \n                        <tbody>  \n                            ${n.produk.map((n=>`  \n                                <tr>  \n                                    <td>${n.nama}</td>  \n                                    <td style="text-align: right;">${n.jumlah} Ã— ${n.harga.toLocaleString()}</td>  \n                                    <td style="text-align: right; font-weight: 500;">${(n.harga*n.jumlah).toLocaleString()}</td>  \n                                </tr>  \n                            `)).join("")}  \n                        </tbody>  \n                    </table>  \n\n                    <hr style="border-top: 1px dashed #4a90e2; margin: 8px 0; opacity: 0.7;">  \n\n                    \x3c!-- Ringkasan Pembayaran --\x3e  \n                    <div style="font-size: 0.8rem; margin-bottom: 10px;">  \n                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">  \n                            <span style="color: #6c757d;">Total:</span>  \n                            <span style="font-weight: bold; color: #2c3e50;">Rp ${n.totalHarga.toLocaleString()}</span>  \n                        </div>  \n                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">  \n                            <span style="color: #6c757d;">Bayar:</span>  \n                            <span style="font-weight: bold; color: #28a745;">Rp ${n.uangDiterima.toLocaleString()}</span>  \n                        </div>  \n                        <div style="display: flex; justify-content: space-between;">  \n                            <span style="color: #6c757d;">Kembali:</span>  \n                            <span style="font-weight: bold; color: #dc3545;">Rp ${n.kembalian.toLocaleString()}</span>  \n                        </div>  \n                    </div>  \n\n                    <hr style="border-top: 1px dashed #4a90e2; margin: 8px 0; opacity: 0.7;">  \n\n                    \x3c!-- Footer --\x3e  \n                    <div style="text-align: center;">  \n                        <p style="font-size: 0.7rem; color: #6c757d; margin-bottom: 5px;">  \n                            ${t.catatanKakiStruk||"Terima Kasih"}  \n                        </p>  \n                        \n                        <div class="premium2">  \n                            <p class="small mb-0 premium2" style="color: #4a90e2; font-weight: 500; font-size: 0.7rem;">  \n                                <i class="fas fa-lock"></i> by: walletku.biz.id  \n                            </p>  \n                        </div>  \n                        <div class="premium2">  \n                            <p style="font-size: 0.7rem; color: #4a90e2; font-weight: 500; margin: 0;" class="premium2">  \n                                <i class="fas fa-lock"></i> WalletKu.biz.id | Upgrade Premium  \n                            </p>  \n                        </div>  \n                    </div>  \n                </div>  \n            </div>  \n        `}(n)}  \n                    <script>  \n                        window.onload = function() {  \n                            window.print();  \n                            window.close();  \n                        }  \n                    <\/script>  \n                </body>  \n            </html>  \n        `),t.document.close()):alert("Nota tidak valid")}function L(e){const i=e.reduce(((n,t)=>n+t.totalHarga),0),o=e.reduce(((n,t)=>n+t.produk.reduce(((n,t)=>{const a=k.find((n=>n.namaProduk===t.nama));return n+(t.harga-a.hargaModal)*t.jumlah}),0)),0),l=e.reduce(((n,t)=>n+t.produk.reduce(((n,t)=>n+t.jumlah),0)),0);n.textContent=`Rp ${i.toLocaleString()}`,t.textContent=`Rp ${o.toLocaleString()}`,a.textContent=l}function D(n){const t=document.getElementById("grafikFrekuensi").getContext("2d");if(x&&x.destroy(),0===f.length)return x&&x.destroy(),void(document.getElementById("grafikFrekuensi").innerHTML='<p class="text-muted text-center">Tidak ada data transaksi</p>');let a=[],e=[];const i=new Date;if("harian"===n)a=Array.from({length:24},((n,t)=>`${t}:00`)),e=Array(24).fill(0),f.forEach((n=>{const t=new Date(n.tanggal);if(t.toDateString()===i.toDateString()){const n=t.getHours();e[n]++}}));else if("mingguan"===n){a=["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"],e=Array(7).fill(0);const n=new Date;n.setDate(i.getDate()-7),f.forEach((t=>{const a=new Date(t.tanggal);if(a>=n){const n=a.getDay();e[n]++}}))}else if("bulanan"===n){const n=new Date(i.getFullYear(),i.getMonth()+1,0).getDate();a=Array.from({length:n},((n,t)=>`Tgl ${t+1}`)),e=Array(n).fill(0),f.forEach((n=>{const t=new Date(n.tanggal);if(t.getMonth()===i.getMonth()&&t.getFullYear()===i.getFullYear()){const n=t.getDate()-1;e[n]++}}))}x=new Chart(t,{type:"bar",data:{labels:a,datasets:[{label:"Jumlah Transaksi",data:e,backgroundColor:"rgba(54, 162, 235, 0.7)",borderColor:"rgba(54, 162, 235, 1)",borderWidth:1,borderRadius:4}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{precision:0,callback:function(n){if(Number.isInteger(n))return n}}}},plugins:{tooltip:{callbacks:{label:function(n){return`Transaksi: ${n.parsed.y}`}}}}}})}function T(n){[btnTimeHarian,btnTimeMingguan,btnTimeBulanan].forEach((n=>{n.classList.remove("active")})),document.getElementById(n).classList.add("active")}function S(n,t=null){const a=document.getElementById("grafikPenjualan").getContext("2d");v&&v.destroy();const e=t||f,i={harian:{label:"Penjualan Harian",groupBy:n=>n.split("T")[0],formatLabel:n=>new Date(n).toLocaleDateString("id-ID"),warna:["rgba(75, 192, 192, 0.6)","rgba(75, 192, 192, 1)"]},mingguan:{label:"Penjualan Mingguan",groupBy:n=>{const t=new Date(n);return new Date(t.setDate(t.getDate()-t.getDay())).toISOString().split("T")[0]},formatLabel:n=>`Minggu ${new Date(n).toLocaleDateString("id-ID")}`,warna:["rgba(255, 159, 64, 0.6)","rgba(255, 159, 64, 1)"]},bulanan:{label:"Penjualan Bulanan",groupBy:n=>n.slice(0,7),formatLabel:n=>{const[t,a]=n.split("-");return`${["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"][parseInt(a)-1]} ${t}`},warna:["rgba(153, 102, 255, 0.6)","rgba(153, 102, 255, 1)"]},tahunan:{label:"Penjualan Tahunan",groupBy:n=>n.slice(0,4),formatLabel:n=>n,warna:["rgba(54, 162, 235, 0.6)","rgba(54, 162, 235, 1)"]}},{label:o,groupBy:l,formatLabel:r,warna:s}=i[n],d=e.reduce(((n,t)=>(n[l(t.tanggal)]=(n[l(t.tanggal)]||0)+t.totalHarga,n)),{}),c=Object.keys(d).sort(),g=c.map((n=>d[n])),m=c.map(r);v=new Chart(a,{type:"bar",data:{labels:m,datasets:[{label:o,data:g,backgroundColor:s[0],borderColor:s[1],borderWidth:1,borderRadius:4,fill:!1}]},options:{responsive:!0,scales:{y:{beginAtZero:!0,ticks:{callback:n=>"Rp "+n.toLocaleString(),color:"#6c757d"},grid:{display:!1},border:{display:!1}},x:{display:!0,ticks:{color:"#6c757d"},grid:{display:!1},border:{display:!1}}},plugins:{tooltip:{callbacks:{label:n=>"Rp "+n.parsed.y.toLocaleString()}},legend:{display:!1}}}})}function E(n=null){let t,a;const e=new Date;switch(n){case"hari-ini":t=new Date,t.setHours(0,0,0,0),a=new Date;break;case"minggu-ini":t=new Date,t.setDate(t.getDate()-t.getDay()),t.setHours(0,0,0,0),a=new Date;break;case"bulan-ini":t=new Date(e.getFullYear(),e.getMonth(),1),a=new Date(e.getFullYear(),e.getMonth()+1,0),a.setHours(23,59,59,999);break;case"tahun-ini":t=new Date(e.getFullYear(),0,1),a=new Date(e.getFullYear(),11,31),a.setHours(23,59,59,999);break;case"custom":t=new Date(d.value),a=new Date(c.value),a&&a.setHours(23,59,59,999);break;default:t=null,a=null}const i=Array.from(s.selectedOptions).map((n=>n.value)),o=f.filter((n=>{const e=new Date(n.tanggal),o=(!t||e>=t)&&(!a||e<=a),l=0===i.length||n.produk.some((n=>i.includes(n.nama)));return o&&l}));L(o),j(o),S("tahun-ini"===n?"tahunan":"bulan-ini"===n||t&&a&&a-t>2592e6?"bulanan":"minggu-ini"===n||t&&a&&a-t>6048e5?"mingguan":"harian",o),B()}function I(n){switch([u,p,b,y,m].forEach((n=>{n.classList.remove("active")})),n){case"hari-ini":u.classList.add("active");break;case"minggu-ini":p.classList.add("active");break;case"bulan-ini":b.classList.add("active");break;case"tahun-ini":y.classList.add("active");break;case"custom":m.classList.add("active")}}function j(n){const t=n.flatMap((n=>n.produk.map((t=>({tanggal:n.tanggal,namaProduk:t.nama,namaPelanggan:n.namaPelanggan,jumlah:t.jumlah,hargaSatuan:t.harga,total:t.harga*t.jumlah,laba:$(t),aksi:n})))));e.innerHTML=t.map(((n,t)=>`  \n            <tr>  \n                <td>${n.tanggal}</td>  \n                <td>${n.namaProduk}</td>\n                <td>${n.jumlah}</td>  \n                <td>Rp ${n.hargaSatuan.toLocaleString()}</td>  \n                <td>Rp ${n.total.toLocaleString()}</td>  \n                <td>Rp ${n.laba.toLocaleString()}</td>  \n                <td>  \n                    <button class="btn btn-sm btn-info cetak-nota" data-index="${t}">  \n                        <i class="fas fa-print"></i>  \n                    </button>  \n                </td>  \n            </tr>  \n        `)).join(""),document.querySelectorAll(".cetak-nota").forEach((n=>{n.addEventListener("click",(n=>{const a=n.currentTarget.dataset.index;w(t[a].aksi)}))}))}function $(n){const t=k.find((t=>t.namaProduk===n.nama));return(n.harga-t.hargaModal)*n.jumlah}function B(){const n=f.flatMap((n=>n.produk)).reduce(((n,t)=>(n[t.nama]=(n[t.nama]||0)+t.jumlah,n)),{}),t=Object.entries(n).sort(((n,t)=>t[1]-n[1])).slice(0,5).map((([n,t])=>`  \n                <li class="list-group-item d-flex justify-content-between align-items-center">  \n                    ${n}  \n                    <span class="badge bg-primary rounded-pill">${t}</span>  \n                </li>  \n            `)).join("");i.innerHTML=t}btnTimeHarian.addEventListener("click",(()=>{D("harian"),T("btnTimeHarian")})),btnTimeMingguan.addEventListener("click",(()=>{D("mingguan"),T("btnTimeMingguan")})),btnTimeBulanan.addEventListener("click",(()=>{D("bulanan"),T("btnTimeBulanan")})),o.addEventListener("click",(()=>{S("harian"),D("harian"),o.classList.add("active"),g.classList.remove("active"),l.classList.remove("active")})),g.addEventListener("click",(()=>{S("mingguan"),g.classList.add("active"),o.classList.remove("active"),l.classList.remove("active")})),l.addEventListener("click",(()=>{S("bulanan"),l.classList.add("active"),o.classList.remove("active"),g.classList.remove("active")})),u.addEventListener("click",(()=>{E("hari-ini"),I("hari-ini")})),p.addEventListener("click",(()=>{E("minggu-ini"),I("minggu-ini")})),b.addEventListener("click",(()=>{E("bulan-ini"),I("bulan-ini")})),y.addEventListener("click",(()=>{E("tahun-ini"),I("tahun-ini")})),m.addEventListener("click",(()=>{E("custom"),I("custom")})),r.addEventListener("click",(()=>{const n=f.flatMap((n=>n.produk.map((t=>({tanggal:n.tanggal,namaPelanggan:n.namaPelanggan,namaProduk:t.nama,jumlah:t.jumlah,hargaSatuan:t.harga,total:t.harga*t.jumlah,laba:$(t)}))))),t=[["Tanggal","Nama Produk","Nama Pelanggan","Jumlah","Harga Satuan","Total","Laba"],...n.map((n=>[n.tanggal,n.namaPelanggan,n.namaProduk,n.jumlah,n.hargaSatuan,n.total,n.laba]))].map((n=>n.join(","))).join("\n"),a=new Blob([t],{type:"text/csv;charset=utf-8;"}),e=document.createElement("a"),i=URL.createObjectURL(a);e.setAttribute("href",i),e.setAttribute("download",`laporan_penjualan_${(new Date).toISOString().split("T")[0]}.csv`),e.style.visibility="hidden",document.body.appendChild(e),e.click(),document.body.removeChild(e)})),f=JSON.parse(localStorage.getItem("nota")||"[]"),k=JSON.parse(localStorage.getItem("produk")||"[]"),s.innerHTML=k.map((n=>`  \n            <option value="${n.namaProduk}">${n.namaProduk}</option>  \n        `)).join(""),L(f),S("harian"),j(f),B(),function(){const n=(new Date).toISOString().split("T")[0],t=f.filter((t=>t.tanggal.includes(n))).length;h.textContent=t;const a=new Date;a.setDate(a.getDate()-1);const e=a.toISOString().split("T")[0],i=f.filter((n=>n.tanggal.startsWith(e))).length,o=document.getElementById("trendIndicator");if(o.innerHTML="",i>0){const n=((t-i)/i*100).toFixed(1),a=t>i?`<i class="fas fa-arrow-up text-success"></i> ${n}%`:`<i class="fas fa-arrow-down text-danger"></i> ${Math.abs(n)}%`;o.innerHTML=`(${a} dari kemarin)`}}()}));
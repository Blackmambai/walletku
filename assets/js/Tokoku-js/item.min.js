document.addEventListener("DOMContentLoaded",(()=>{const a=document.getElementById("daftarProduk"),t=document.getElementById("formProduk"),e=document.getElementById("btnExportProduk"),n=document.getElementById("btnImportProduk"),o=document.getElementById("fileImportProduk"),r=document.getElementById("fotoProduk"),d=document.getElementById("pratinjauFoto"),i=new bootstrap.Modal(document.getElementById("modalTambahProduk")),u=document.getElementById("cariProduk"),s=document.getElementById("btnResetPencarian"),l=document.getElementById("filterKategori");let c=[],k=[],m=-1;function p(a){const t=a.target.files[0];if(t){const a=new FileReader;a.onload=a=>{d.src=a.target.result,d.style.display="block"},a.readAsDataURL(t)}}function g(){c=JSON.parse(localStorage.getItem("produk")||"[]"),k=[],v(),f()}function f(){const t=k.length>0?k:c;a.innerHTML=t.map(((a,e)=>`\n            <div class="col-md-4 col-lg-3 col-sm-6 col-12 mb-4">\n                <div class="card card-produk border-0 shadow" style="border-radius: 16px;">\n                    <img src="${a.fotoProduk||"https://walletku.biz.id/assets/img/image/notfound.webp"}" \n                         class="card-img-top" \n                         alt="${a.namaProduk}"\n                         style="border-radius: 16px 16px 0 0; object-fit: cover;height: 200px" loading="lazy">\n                    <div class="card-body">\n                        <h5 class="fw-bold text-bg-warning card-title" style="padding: 6px;padding-right: 12px;padding-left: 12px;border-radius: 16px;">${a.namaProduk}</h5>\n                        <div class="card-text">\n                            <div class="d-flex flex-column gap-2">\n                                <div>\n                                    <span class="fw-bold" style="margin-left: 12px">Kategori:</span>\n                                    <span class="d-block" style="margin-left: 18px">${a.kategoriProduk}</span>\n                                </div>\n                                <div>\n                                    <span class="fw-bold" style="margin-left: 12px">Harga Jual:</span>\n                                    <span class="d-block" style="margin-left: 18px">Rp ${a.hargaJual.toLocaleString()}</span>\n                                </div>\n                                <div>\n                                    <span class="fw-bold" style="margin-left: 12px">Stok:</span>\n                                    <span class="d-block" style="margin-left: 18px">${a.stokProduk}</span>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="d-flex justify-content-between mt-4 gap-2">\n                            <button class="btn btn-warning flex-grow-1 edit-produk" \n                                    data-index="${t===k?c.indexOf(a):e}"\n                                    style="border-radius: 16px;font-family: Nunito, sans-serif;box-shadow: 0px 6px 14px rgba(67,97,238,0.56);width: auto;border-width: 0px;padding-top: 8px;padding-right: 12px;padding-bottom: 8px;padding-left: 12px;">\n                                <i class="bi bi-pencil"></i> Edit\n                            </button>\n                            <button class="btn btn-danger flex-grow-1 hapus-produk" \n                                    data-index="${t===k?c.indexOf(a):e}"\n                                    style="border-radius: 16px;font-family: Nunito, sans-serif;box-shadow: 0px 6px 14px rgba(67,97,238,0.56);width: auto;">\n                                <i class="bi bi-trash"></i> Hapus\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `)).join(""),document.querySelectorAll(".edit-produk").forEach((a=>{a.addEventListener("click",y)})),document.querySelectorAll(".hapus-produk").forEach((a=>{a.addEventListener("click",b)}))}async function h(a){a.preventDefault();const t={namaProduk:document.getElementById("namaProduk").value,kategoriProduk:document.getElementById("kategoriProduk").value,hargaJual:parseFloat(document.getElementById("hargaJual").value),hargaModal:parseFloat(document.getElementById("hargaModal").value),stokProduk:parseInt(document.getElementById("stokProduk").value),barcodeProduk:document.getElementById("barcodeProduk").value,satuanProduk:document.getElementById("satuanProduk").value,catatanProduk:document.getElementById("catatanProduk").value};if(!t.namaProduk||!t.kategoriProduk||isNaN(t.hargaJual)||isNaN(t.stokProduk))return void await Swal.fire({icon:"error",title:"Data tidak lengkap",text:"Harap isi semua field yang wajib diisi (Nama, Kategori, Harga Jual, Stok)"});const e=r.files[0];if(e){const a=new FileReader;a.onloadend=()=>{t.fotoProduk=a.result,P(t)},a.readAsDataURL(e)}else-1!==m&&(t.fotoProduk=c[m].fotoProduk),P(t)}async function P(a){try{-1===m?c.push(a):(c[m]=a,m=-1),localStorage.setItem("produk",JSON.stringify(c)),f(),v(),t.reset(),d.src="",d.style.display="none",i.hide(),await Swal.fire({position:"center",icon:"success",title:"Produk berhasil disimpan",showConfirmButton:!1,timer:1500})}catch(a){console.error("Error saving product:",a),Swal.fire({icon:"error",title:"Gagal menyimpan",text:"Terjadi kesalahan saat menyimpan produk"})}}function y(a){m=parseInt(a.currentTarget.dataset.index);const t=c[m];document.getElementById("namaProduk").value=t.namaProduk,document.getElementById("kategoriProduk").value=t.kategoriProduk,document.getElementById("hargaJual").value=t.hargaJual,document.getElementById("hargaModal").value=t.hargaModal,document.getElementById("stokProduk").value=t.stokProduk,document.getElementById("barcodeProduk").value=t.barcodeProduk||"",document.getElementById("satuanProduk").value=t.satuanProduk||"",document.getElementById("catatanProduk").value=t.catatanProduk||"",t.fotoProduk?(d.src=t.fotoProduk,d.style.display="block"):(d.src="",d.style.display="none"),i.show()}async function b(a){const t=parseInt(a.currentTarget.dataset.index),{isConfirmed:e}=(c[t],await Swal.fire({title:"PERHATIKAN!",text:"Produk yang dihapus mungkin akan mempengaruhi laporan : hilangnya riwayat transaksi produk tersebut yang telah di proses sebelumnya dan tidak dapat dipulihkan. tetap menghapus produk '${produk.namaProduk}'?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Lanjutkan!",cancelButtonText:"Urungkan"}));e&&(c.splice(t,1),localStorage.setItem("produk",JSON.stringify(c)),f(),v(),await Swal.fire("Terhapus!","Produk telah dihapus.","success"))}function w(){const a=u.value.toLowerCase().trim(),t=l?l.value:"";if(!a&&!t)return k=[],void f();k=c.filter((e=>{const n=e.namaProduk.toLowerCase().includes(a)||e.kategoriProduk.toLowerCase().includes(a)||e.barcodeProduk&&e.barcodeProduk.toLowerCase().includes(a)||e.catatanProduk&&e.catatanProduk.toLowerCase().includes(a)||e.hargaJual.toString().includes(a)||e.stokProduk.toString().includes(a),o=!t||e.kategoriProduk===t;return n&&o})),f()}function x(){u.value="",l&&(l.value=""),k=[],f()}function v(){if(!l)return;const a=l.value,t=[...new Set(c.map((a=>a.kategoriProduk)))];l.innerHTML=`\n            <option value="">Semua Kategori</option>\n            ${t.map((a=>`<option value="${a}">${a}</option>`)).join("")}\n        `,t.includes(a)&&(l.value=a)}async function E(a){const t=a.target.files[0];if(!t)return;const{value:e}=await Swal.fire({title:"Konfirmasi Import",text:`Anda akan mengimpor data dari ${t.name}`,icon:"question",showCancelButton:!0,confirmButtonText:"Import",cancelButtonText:"Batal",showLoaderOnConfirm:!0,preConfirm:async()=>{try{const a=await function(a){return new Promise(((t,e)=>{const n=new FileReader;n.onload=a=>t(a.target.result),n.onerror=a=>e(a),a.name.endsWith(".csv")?n.readAsText(a):n.readAsArrayBuffer(a)}))}(t);let e=[];if(t.name.endsWith(".csv"))e=function(a){const t=a.split("\n"),e=t[0].split(",").map((a=>a.trim().toLowerCase()));return t.slice(1).map((a=>{if(!a.trim())return null;const t=a.split(","),n={};return e.forEach(((a,e)=>{const o=t[e]?t[e].trim():"";switch(a){case"nama produk":n.namaProduk=o;break;case"kategori":n.kategoriProduk=o;break;case"harga jual":n.hargaJual=parseFloat(o.replace(/[^0-9.]/g,""))||0;break;case"harga modal":n.hargaModal=parseFloat(o.replace(/[^0-9.]/g,""))||0;break;case"stok":n.stokProduk=parseInt(o.replace(/[^0-9]/g,""))||0;break;case"barcode":n.barcodeProduk=o;break;case"satuan":n.satuanProduk=o;break;case"catatan":n.catatanProduk=o}})),n.namaProduk?n:null})).filter((a=>null!==a))}(a);else{if(!t.name.endsWith(".xlsx")&&!t.name.endsWith(".xls"))throw new Error("Format file tidak didukung");if("undefined"==typeof XLSX)throw new Error("Library SheetJS diperlukan untuk import Excel");e=function(a){const t=XLSX.read(a,{type:"array"}),e=t.Sheets[t.SheetNames[0]];return XLSX.utils.sheet_to_json(e).map((a=>{const t={namaProduk:a["Nama Produk"]||a.namaProduk||"",kategoriProduk:a.Kategori||a.kategoriProduk||"",hargaJual:parseFloat(a["Harga Jual"]||a.hargaJual||0),hargaModal:parseFloat(a["Harga Modal"]||a.hargaModal||0),stokProduk:parseInt(a.Stok||a.stokProduk||0),barcodeProduk:a.Barcode||a.barcodeProduk||"",satuanProduk:a.Satuan||a.satuanProduk||"",catatanProduk:a.Catatan||a.catatanProduk||""};return t.namaProduk?t:null})).filter((a=>null!==a))}(a)}if(0===e.length)throw new Error("Tidak ada produk yang valid ditemukan dalam file");return{success:!0,count:e.length,products:e}}catch(a){return Swal.showValidationMessage(`Import gagal: ${a.message}`),!1}}});if(e&&e.success){const a=[...c];let t=0;e.products.forEach((e=>{const n=a.findIndex((a=>a.namaProduk===e.namaProduk||a.barcodeProduk&&a.barcodeProduk===e.barcodeProduk));-1!==n?(a[n]=e,t++):a.push(e)})),c=a,localStorage.setItem("produk",JSON.stringify(c)),g();let n=`Berhasil mengimport ${e.count} produk.`;t>0&&(n+=` ${t} produk yang sudah ada diperbarui.`),await Swal.fire({title:"Import Berhasil",text:n,icon:"success"})}a.target.value=""}async function S(){if(0===c.length)return void await Swal.fire({icon:"info",title:"Tidak ada data",text:"Tidak ada produk untuk diexport"});const{value:a}=await Swal.fire({title:"Export Data",text:"Pilih format export:",input:"select",inputOptions:{csv:"CSV",xlsx:"Excel"},inputValue:"csv",showCancelButton:!0,inputValidator:a=>{if(!a)return"Anda harus memilih format!"}});if(!a)return;const{value:t}=await Swal.fire({title:"Nama File",input:"text",inputValue:`produk_${(new Date).toISOString().split("T")[0]}`,showCancelButton:!0,inputValidator:a=>{if(!a)return"Anda harus memberi nama file!"}});if(t)try{"csv"===a?function(a){const t=[["Nama Produk","Kategori","Harga Jual","Harga Modal","Stok","Barcode","Satuan","Catatan"],...c.map((a=>[`"${a.namaProduk}"`,`"${a.kategoriProduk}"`,a.hargaJual,a.hargaModal,a.stokProduk,`"${a.barcodeProduk||""}"`,`"${a.satuanProduk||""}"`,`"${a.catatanProduk||""}"`]))].map((a=>a.join(","))).join("\n");!function(a,t){const e=document.createElement("a"),n=URL.createObjectURL(a);e.setAttribute("href",n),e.setAttribute("download",t),e.style.visibility="hidden",document.body.appendChild(e),e.click(),document.body.removeChild(e)}(new Blob([t],{type:"text/csv;charset=utf-8;"}),`${a}.csv`)}(t):"xlsx"===a&&function(a){if("undefined"==typeof XLSX)throw new Error("Library SheetJS diperlukan untuk export Excel");const t=c.map((a=>({"Nama Produk":a.namaProduk,Kategori:a.kategoriProduk,"Harga Jual":a.hargaJual,"Harga Modal":a.hargaModal,Stok:a.stokProduk,Barcode:a.barcodeProduk||"",Satuan:a.satuanProduk||"",Catatan:a.catatanProduk||""}))),e=XLSX.utils.book_new(),n=XLSX.utils.json_to_sheet(t);XLSX.utils.book_append_sheet(e,n,"Daftar Produk"),XLSX.writeFile(e,`${a}.xlsx`)}(t),await Swal.fire({position:"center",icon:"success",title:"Export Berhasil",showConfirmButton:!1,timer:1500})}catch(a){console.error("Export error:",a),await Swal.fire({icon:"error",title:"Export Gagal",text:"Terjadi kesalahan saat mengekspor data"})}}!function(){r.addEventListener("change",p),t.addEventListener("submit",h),n&&o&&(n.addEventListener("click",(()=>o.click())),o.addEventListener("change",E));e&&e.addEventListener("click",S);u.addEventListener("input",w),s.addEventListener("click",x),l&&l.addEventListener("change",w)}(),g()}));